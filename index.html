<html>
	<head>
		<meta charset="utf-8">
		<title>Knitout for Kniterate</title>
		<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400&display=swap" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300&display=swap" rel="stylesheet">
		<link href="style.css" rel="stylesheet">
	</head>
	<body>
		<h1>Knitout to KCode</h1>
		<p>
This page will convert <a href="https://github.com/textiles-lab/knitout">knitout</a> -- a low-level knitting machine output language -- into <a class="broken" href="">kcode</a>, the format used by <a href="https://kniterate.com/">Kniterate</a> knitting machines.
		</p>
		<p>
<li>&ensp;<a href="https://github.com/textiles-lab/knitout-backend-kniterate/issues">report bugs</a></li><br>
<li>&ensp;<a href="https://github.com/textiles-lab/knitout-backend-kniterate/">get source code</a> (includes a command-line version)</li>
		</p>
		<br>
<div id="wrapper">
	<div id="column1">
		<h2>Knitout <span style="font-size:16px">(input)</span></h2>
		<label for="infile" class="button">Load a Knitout File</label> or drag one into the window.<br>
		<input type="file" id="infile" style="display:none">
				<h2>Messages</h2>
				<ul id="messages" style="background-color:#282a36; padding-right:1em">
					<br>
					<li>(none yet)</li><br>
				</ul>
	</div>
	<div id="column2">
		<h2>KCode <span style="font-size:16px">(output)</span></h2>
		<a id="kcode-download" title="No file chosen" class="button inactive" href="" download="">Download</a><br><br>
		<div id="top-scroll">
			<div id="top"></div>
		</div>
		<textarea id="output" style="width:fit-content">
(no output yet)
		</textarea>
	</div>	
</div>
<div id="dropTarget"></div>

		<script src="knitout-to-kcode.js"></script>
		<script>

			//link pseudo-top scroll bar to output for scrolling through horizontal overflow
			const topScroll = document.getElementById('top-scroll');
			const output = document.getElementById('output');
			topScroll.onscroll = function () {
					output.scrollLeft = topScroll.scrollLeft;
				}
				output.onscroll = function () {
					topScroll.scrollLeft = output.scrollLeft;
				}

			function processKnitout(filename, text) {
				//automatically add console logs to messages innerHTML
				const real = {
					log:console.log,
					info:console.info,
					warn:console.warn,
					error:console.error,
					assert:console.assert
				}
				const messages = document.getElementById('messages');
				function makeMessage() {
					let message = '';
					for (const a of arguments) {
						if (typeof a === 'object') {
							message += JSON.stringify(a, undefined, 2);
						} else {
							message += a.toString();
						}
					}
					return message;
				}
				for (const name of ['log', 'info', 'warn', 'error']) {
					console[name] = function () {
						real[name](...arguments); //also log to console
						const li = document.createElement("LI");
						li.classList.add(name);
						li.innerText = makeMessage(...arguments);
						messages.appendChild(li);
					};
				}

				try {
					let kcFile;
					let i = filename.lastIndexOf('.');
					if (i === -1) kcFile = filename + '.kc';
					else kcFile = filename.substr(0,i) + '.kc';
					const {headers, passes} = knitoutToPasses(text, filename);
					const kcode = passesToKCode(headers, passes, kcFile);
					//join array with line breaks; write file to blob
					const kcodeStr = kcode.join('\n');
					const blob = new Blob([kcodeStr], { type: "text/kc" });
					output.innerHTML = kcodeStr;
					//add top scroll/fit content nicely
					output.style.width = '98%',
						output.style.whiteSpace = 'pre';
					topScroll.style.width = '98%',
						topScroll.style.overflowX = 'scroll',
						topScroll.style.overflowY = 'hidden';
					(output.scrollHeight >= 700) ? output.style.height = '700px' : ((output.style.height = 'auto'), (output.style.height = output.scrollHeight + 'px'), (output.style.overflowY = 'hidden'));
				  const top = document.getElementById('top');
					top.style.width = 1.02 * output.scrollWidth;
					top.style.height = '20px';
					//create output file & add properties to download button
					const url = URL.createObjectURL(blob);
					const a = document.getElementById('kcode-download');
					a.href = url;
					a.download = kcFile;
					a.classList.remove('inactive');
					a.removeAttribute('title');
				} catch (e) {
					console.error(e);
				}

				for (const name of ['log', 'info', 'warn', 'error']) {
					console[name] = real[name];
				}
			}

			//file loading modified from knitout-live-visualizer:
			function readFile(file) {
				const m = document.getElementById('messages');
				m.innerHTML = '<br>'; //clear messages '(none yet)' placeholder
				console.log("Attempting to read file: '" + file.name + "'.");

				//generate new data:
				var reader = new FileReader();
				reader.onload = function(){
					//document.getElementById('fileName').innerText = file.name;
					console.log("read " + file.name);
					let text = reader.result;
					let oldText = text;
					//line ending conversion:
					text = text.replace(/\r\n/g,"\n");
					if (oldText != text) {
						console.warn("Converted dos-style line endings to unix-style.");
					}
					processKnitout(file.name, reader.result);
				};
				console.log("reading " + file.name + ".");
				reader.readAsText(file);

			}

			const infile = document.getElementById('infile');
			infile.addEventListener('change', (evt) => {
				readFile(infile.files[0]);
				evt.preventDefault();
				return false;
			});

			const dropTarget = document.getElementById("dropTarget");
			//dragging into the window also loads files:
			dropTarget.addEventListener('dragover', function(evt){
				dropTarget.classList.add("active");
				evt.preventDefault();
				return false;
			});
			dropTarget.addEventListener('dragleave', function(evt){
				dropTarget.classList.remove("active");
				evt.preventDefault();
				return false;
			});
			dropTarget.addEventListener('drop', function(evt){
				dropTarget.classList.remove("active");
				try {
					readFile(evt.dataTransfer.files[0]);
				} catch (e) {
					console.log(e);
				}
				evt.preventDefault();
				return false;
			});
			
			//dragging into the window shows the target:
			document.addEventListener('dragover', function(evt){
				dropTarget.classList.add("active");
				evt.preventDefault();
				return false;
			});



		</script>
	</body>
</html>
