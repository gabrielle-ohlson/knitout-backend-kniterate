<html>
	<head>
		<meta charset="utf-8">
		<title>Knitout for Kniterate</title>
	</head>
	<body>
		<h1>Knitout to KCode</h1>
		<p>
This page will convert <a href="https://github.com/textiles-lab/knitout">knitout</a> -- a low-level knitting machine output language -- in to <a href="">kcode</a>, the format used by <a href="">Kniterate</a> knitting machines.
		</p>
		<p>
<a href="https://github.com/textiles-lab/knitout-backend-kniterate/issues">report bugs</a><br>
<a href="https://github.com/textiles-lab/knitout-backend-kniterate/">get source code</a> (includes a command-line version)
		</p>

		<h2>Knitout (input)</h2>
		<label for="infile">Select a knitout (.k / .knitout) file or drag one into the window.</label><br>
		<input type="file" id="infile">

		<h2>Messages</h2>
		<div id="messages">
			(none yet)
		</div>

		<h2>KCode (output)</h2>
		<a id="kcode-download" href="" download="">download</a><br><br>
		<div id="top-scroll">
			<div id="pseudo"></div>
			</div>
		<textarea id="output" style="width:fit-content;">
(no output yet)
</textarea>

		<script src="knitout-to-kcode.js"></script>
		<script>
			//automatically add console logs to messages innerHTML
			(function () {
				let log = console.log;
				const m = document.getElementById('messages');
				console.log = function () {
					for (var i = 0; i < arguments.length; ++i) {
						if (typeof arguments[i] == 'object') {
							m.innerHTML += (JSON && JSON.stringify ? JSON.stringify(arguments[i], undefined, 2) : arguments[i]) + '<br />';
						} else {
							m.innerHTML += arguments[i] + '<br />';
						}
					}
					log(...arguments); //also log to console
					}
			})();
			//link pseudo-top scroll bar to output for scrolling through horizontal overflow
			const topScroll = document.getElementById('top-scroll');
			const output = document.getElementById('output');
			topScroll.onscroll = function () {
					output.scrollLeft = topScroll.scrollLeft;
				}
				output.onscroll = function () {
					topScroll.scrollLeft = output.scrollLeft;
				}

			function processKnitout(filename, text) {
				try {
					let kcFile;
					let i = filename.lastIndexOf('.');
					if (i === -1) kcFile = filename + '.kc';
					else kcFile = filename.substr(0,i) + '.kc';
					const {headers, passes} = knitoutToPasses(text, filename);
					const kcode = passesToKCode(headers, passes, kcFile);
					//join array with line breaks; write file to blob
					const kcodeStr = kcode.join('\n');
					const blob = new Blob([kcodeStr], { type: "text/kc" });
					output.innerHTML = kcodeStr;
					//add top scroll/fit content nicely
					output.style.width = '98%',
						output.style.whiteSpace = 'nowrap';
					topScroll.style.width = '98%',
						topScroll.style.overflowX = 'scroll',
						topScroll.style.overflowY = 'hidden';
					(output.scrollHeight >= 700) ? output.style.height = '700px' : ((output.style.height = 'auto'), (output.style.height = output.scrollHeight + 'px'), (output.style.overflowY = 'hidden'));
					document.getElementById('pseudo').style.width = 1.2 * output.scrollWidth;
					document.getElementById('pseudo').style.height = '20px';
					//create output file & add properties to download button
					const url = URL.createObjectURL(blob);
					const a = document.getElementById('kcode-download');
					a.href = url;
					a.download = kcFile;
				} catch (e) {
					console.error(e);
				}

			}

			//file loading modified from knitout-live-visualizer:
			function readFile(file) {
				const m = document.getElementById('messages');
				m.innerHTML = ''; //clear messages '(none yet)' placeholder
				console.log("Attempting to read file: '" + file.name + "'.");

				//generate new data:
				var reader = new FileReader();
				reader.onload = function(){
					//document.getElementById('fileName').innerText = file.name;
					console.log("read " + file.name);
					let text = reader.result;
					let oldText = text;
					//line ending conversion:
					text = text.replace(/\r\n/g,"\n");
					if (oldText != text) {
						console.warn("Converted dos-style line endings to unix-style.");
					}
					processKnitout(file.name, reader.result);
				};
				console.log("reading " + file.name + ".");
				reader.readAsText(file);

			}

			const infile = document.getElementById('infile');
			infile.addEventListener('change', (evt) => {
				readFile(infile.files[0]);
				infile.value = " "; //add space so default 'no file chosen' goes away
				evt.preventDefault();
				return false;
			});

			/*
			var dropTarget = document.getElementById("dropTarget");
			//dragging into the window also loads files:
			dropTarget.addEventListener('dragover', function(evt){
				dropTarget.classList.add("active");
				evt.preventDefault();
				return false;
			});
			dropTarget.addEventListener('dragleave', function(evt){
				dropTarget.classList.remove("active");
				evt.preventDefault();
				return false;
			});
			dropTarget.addEventListener('drop', function(evt){
				dropTarget.classList.remove("active");
				try {
					readFile(evt.dataTransfer.files[0]);
				} catch (e) {
					console.log(e);
				}
				evt.preventDefault();
				return false;
			});
			
			//dragging into the window shows the target:
			document.addEventListener('dragover', function(evt){
				dropTarget.classList.add("active");
				evt.preventDefault();
				return false;
			});
			*/



		</script>
	</body>
</html>
